
# Yolov3 detection
Detect object in video with [darknet YoloV3 method](https://pjreddie.com/darknet/yolo/)

## Python environment
- Version: Python 3.6.8
- requirments:
```
numpy==1.17.4
opencv-python==4.1.2.30
pymongo==3.9.0
redis==3.3.11
```
- Test in: Ubuntu 18.04.3 LTS

## Setup

### Setup for YoloV3
Put the following file in e.g. `darkent/` folder
- [coco.names](https://raw.githubusercontent.com/pjreddie/darknet/master/data/coco.names)
- [yolov3.cfg](https://raw.githubusercontent.com/pjreddie/darknet/master/cfg/yolov3.cfg)
- [yolov3.weights](https://pjreddie.com/media/files/yolov3.weights)

test video `yolotest.mp4` is from https://www.youtube.com/watch?v=vF1RPI6j7b0

### global constant
change constant in `globalconstant.py`

## Openfass handler
1. asynchandler.py
2. handler.py

### asynchandler.py
handle trigger process request

- url: e.g. `http://127.0.0.1:31112/async-function/process`
- set header: e.g. `X-Callback-Url=http://127.0.0.1:31112/function/detection`
- request body: filename:String, e.g. `yolotest.mp4`
- response body: userid (object id in MongoDB process collection)

Check MongoDB process collection to get the process status.

test: see `asynchandlerTest.py`
```
$ python3 asynchandlerTest.py 
5de78728d1694216c0eb0ee7
```

requirements
```
pymongo==3.9.0
```

for openFass handler
```
$faas-cli new --lang python3 process
```
```
process.yml (auto gen by fass-cli)
process/
├── handler.py   #replace with asynchandler.py
├── globalconstant.py
├── mongodbController.py
└── requirements.txt (refer above requirements)
```

### handler.py
handle detection

- url: e.g. `http://127.0.0.1:31112/function/detection`
- request body: filename:String, e.g. `yolotest.mp4`
- response body: (ignore)

Check MongoDB user collection with userid to get the processed images.

test: see `handlerTest.py`
```
$ python3 handlerTest.py 
video temp path:  /tmp/yolotest.mp4
Reading Frame...
Read Frame total:  19
Userid:  5de78728d1694216c0eb0ee7
```

requirments:
```
numpy==1.17.4
opencv-python==4.1.2.30
pymongo==3.9.0
redis==3.3.11
```

for openFass handler
```
$faas-cli new --lang python3 detection
```
```
detection.yml (auto gen by fass-cli)
detection/
├── handler.py   #replace with handler.py
├── globalconstant.py
├── mongodbController.py
├── redisController.py
├── darknet
│   └── __init__.py
└── requirements.txt (refer above requirements)
```

## Database
Redis and MongoDB

### Redis
Store video binary

schema:
```Javascript
{
    "key":String, //videoname 
    "value": Bytes, //videoBytes
```

test: see `asynchandlerTest.py`

### MongoDB
Database has one collection for all users process and one collection per user name.
- Database name: `comp4651`
- Users process collection name: `process`
- User collection name pattern: `user_<videoname>`, e.g. `user_yolotest.mp4`

test: see `handlerTest.py`

#### User process
Store all users process.

status: 
- `pending`: processing
- `done`: processed
- `removed`: user's collection removed

schema:
```Javascript
{
    "_id":ObjectId, //userobject id (generated by mongodb)
    "username": String, //videoname 
    "status": String, //process status
}
```

get particular user status:
```python
mongoclient = pymongo.MongoClient("mongodb://localhost:27017/")
comp4651DB = mongoclient["comp4651"]
processCol = comp4651DB["process"]
status = processCol.find_one({"_id":userid})["status"]
```

#### User collection
schema:
```Javascript
{
    "_id":ObjectId, //image id (generated by mongodb)
    "frameno": float, //frame number
    "name": String, //image name
    "userid": String, //user object id string
    "base64": String, //base64 encoded jpg,
}
```

get all image of the user:
```python
mongoclient = pymongo.MongoClient("mongodb://localhost:27017/")
comp4651DB = mongoclient["comp4651"]
comp4651DB["user_"+str(videoname)].find({"userid":userid}).sort("frameno")
```

base64 for test in client: `yolotest.mp4_0.jpg_w.txt`
- `data:image/jpeg;base64, <base64>`
