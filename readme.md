
# Yolov3 detection
Detect object in video with [darknet YoloV3 method](https://pjreddie.com/darknet/yolo/)

## Python environment
- Version: Python 3.6.8
- requirments:
```
numpy==1.17.4
opencv-python==4.1.2.30
pymongo==3.9.0
redis==3.3.11
```
- Test in: Ubuntu 18.04.3 LTS

## Setup

### Setup for YoloV3
Put the following file in e.g. `darkent/` folder
- [coco.names](https://raw.githubusercontent.com/pjreddie/darknet/master/data/coco.names)
- [yolov3.cfg](https://raw.githubusercontent.com/pjreddie/darknet/master/cfg/yolov3.cfg)
- [yolov3.weights](https://pjreddie.com/media/files/yolov3.weights)

test video `yolotest.mp4` is from https://www.youtube.com/watch?v=vF1RPI6j7b0

### global constant
change constant in `globalconstant.py`

## Openfass handler
1. asynchandler.py
2. handler.py

**Method1:**

use `openfass/Dockerfile` to build or add following line in the dockerfile:
```
FROM python:3-alpine

...

#### ADD THIS #####
# Allows you to add additional self packages via build-arg
ARG ADDITIONAL_MYPACKAGE
#################
...

ENV PYTHONPATH=$PYTHONPATH:/home/app/python

...

#### ADD THIS #####
### directly copy package to python path 
WORKDIR /home/app/python/
COPY ${ADDITIONAL_MYPACKAGE} .
### 
#################
```

**Method2**

use the `openfass/__init__.py` in the function package

### asynchandler.py
handle trigger process request

- url: e.g. `http://127.0.0.1:31112/async-function/process`
- set header: e.g. `X-Callback-Url=http://127.0.0.1:31112/function/detection`
- request body: filename:String, e.g. `yolotest.mp4`
- response body: userid (object id in MongoDB process collection)

Check MongoDB process collection to get the process status.

test: see `asynchandlerTest.py`
```shell
$ python3 asynchandlerTest.py 
5de78728d1694216c0eb0ee7
```

if user already exist with show remove line 
```shell
$ python3 asynchandlerTest.py 
remove:  user_yolotest.mp4
5de9cb36f0dc1e627908a220
```

requirements
```
pymongo==3.9.0
```

#### Build openFass function

create openFass handler:
```shell
$ faas-cli new --lang python3 process
```

put file in it:
```
process.yml (auto gen by fass-cli)
process/
├── handler.py   #replace with asynchandler.py
├── mypackage
│   ├──  globalconstant.py
│   ├── mongodbController.py
│   └── __init__.py   #if use method2, replace with "openfass/__init__.py"
└── requirements.txt (refer above requirements)
```

build:

Method1:
```shell
$ faas-cli build -f process.yml --build-arg ADDITIONAL_MYPACKAGE=function/mypackage
```

Method2:
```shell
$ faas-cli build -f detection.yml
```

### handler.py
handle detection

- url: e.g. `http://127.0.0.1:31112/function/detection`
- request body: filename:String, e.g. `yolotest.mp4`
- response body: (ignore)

Check MongoDB user collection with userid to get the processed images.

test: see `handlerTest.py`
```shell
$ python3 handlerTest.py 
video temp path:  /tmp/yolotest.mp4
Reading Frame...
Read Frame total:  19
Userid:  5de78728d1694216c0eb0ee7
```

requirments:
```
numpy==1.17.4
opencv-python==4.1.2.30
pymongo==3.9.0
redis==3.3.11
```

#### Build openFass function

create openFass handler:
```shell
$ faas-cli new --lang python3 detection
```

put file in it:
```
detection.yml (auto gen by fass-cli)
detection/
├── handler.py   #replace with handler.py
├── mypackage
│   ├── globalconstant.py
│   ├── mongodbController.py
│   ├── redisController.py
│   ├── darknet.py
│   └── __init__.py    #if use method2, replace with "openfass/__init__.py"
└── requirements.txt (refer above requirements)
```

build:

Method1:
```shell
$ faas-cli build -f detection.yml --build-arg ADDITIONAL_MYPACKAGE=function/mypackage
```

Method2:
```shell
$ faas-cli build -f detection.yml
```

## Database
Redis and MongoDB

### Redis
Store video binary

schema:
```Javascript
{
    "key":String, //videoname 
    "value": Bytes, //videoBytes
```

test: see `asynchandlerTest.py`

### MongoDB
Database has one collection for all users process and one collection per user name. If duplicated user name, remove collection of older user name. 
- Database name: `comp4651`
- Users process collection name: `process`
- User collection name pattern: `user_<videoname>`, e.g. `user_yolotest.mp4`

test: see `handlerTest.py`

#### User process
Store all users process.

status: 
- `pending`: processing
- `done`: processed
- `removed`: user's collection removed

schema:
```Javascript
{
    "_id":ObjectId, //userobject id (generated by mongodb)
    "username": String, //videoname 
    "status": String, //process status
}
```

get particular user status:
```python
mongoclient = pymongo.MongoClient("mongodb://localhost:27017/")
comp4651DB = mongoclient["comp4651"]
processCol = comp4651DB["process"]
status = processCol.find_one({"_id":userid})["status"]
```

get lastest user objectid:
```python
mongoclient = pymongo.MongoClient("mongodb://localhost:27017/")
comp4651DB = mongoclient["comp4651"]
processCol = comp4651DB["process"]
result = processCol.find({"username":username})
for x in result:
    if x["status"]!="removed":
        userid = str(x["_id"])
```

#### User collection
schema:
```Javascript
{
    "_id":ObjectId, //image id (generated by mongodb)
    "frameno": float, //frame number
    "name": String, //image name
    "userid": String, //user object id string
    "base64": String, //base64 encoded jpg,
}
```

get all image of the user:
```python
mongoclient = pymongo.MongoClient("mongodb://localhost:27017/")
comp4651DB = mongoclient["comp4651"]
comp4651DB["user_"+str(videoname)].find({"userid":userid}).sort("frameno")
```

base64 for test in client: `yolotest.mp4_0.jpg_w.txt`
- `data:image/jpeg;base64, <base64>`
