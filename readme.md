
# Yolov3 detection openfass handler
Detect object in video with [darknet YoloV3 method](https://pjreddie.com/darknet/yolo/)

- (web part)[https://github.com/ytlamal/comp4651_project]: ytlamal
- (container part)[https://github.com/sheldonchiu/Comp4651-Project]: sheldonchiu

## Python environment
- Version: Python 3.6.8
- requirments:
```
numpy==1.17.4
opencv-python==4.1.2.30
pymongo==3.9.0
redis==3.3.11
```
- Locally Tested in: 
    - os: Ubuntu 18.04.3 LTS
    - redis: Redis 5.0.6 (00000000/0) 64 bit
    - mongodb: mongodb-linux-x86_64-ubuntu1804-4.2.1

- build openfass Tested in:
    - minikube
    - Kubernetes
    - follow [this](https://medium.com/faun/getting-started-with-openfaas-on-minikube-634502c7acdf)

## Setup

### Setup for YoloV3
Put the following file in `<cwd>/darkent/` folder
- [coco.names](https://raw.githubusercontent.com/pjreddie/darknet/master/data/coco.names)
- [yolov3.cfg](https://raw.githubusercontent.com/pjreddie/darknet/master/cfg/yolov3.cfg)
- [yolov3.weights](https://pjreddie.com/media/files/yolov3.weights)

### global constant
change constant in `globalconstant.py`

## Openfass handler
**handler.py**
- handle detection

### test in local device: 
use `handlerTest.py`, test example:
```shell
$ python3 handlerTest.py 
video temp path:  /tmp/yolotest.mp4
Reading Frame...
Read Frame total:  19
Userid:  5de78728d1694216c0eb0ee7
```
test video `yolotest.mp4` is from https://www.youtube.com/watch?v=vF1RPI6j7b0

### Build openFass function

requirments:
```
numpy==1.17.4
opencv-python==4.1.2.30
pymongo==3.9.0
redis==3.3.11
```

#### create openFass handler:
```shell
$ faas-cli template pull https://github.com/openfaas-incubator/python3-debian
$ faas-cli new --lang python3-debian detection
```

put file in it:
```
detection.yml (auto gen by fass-cli)
detection/
├── handler.py   #replace with handler.py
├── mypackage
│   ├── globalconstant.py
│   ├── mongodbController.py
│   ├── redisController.py
│   ├── darknet.py
│   └── __init__.py 
├── __init__.py  #replace with "openfass/__init__.py" (for additional module method2)
└── requirements.txt   #replace with "openfass/requirements.txt"
```

replace `template/python3-debian/Dockerfile` with `openfass/Dockerfile`

#### build:

```shell
$ faas-cli build -f detection.yml
```

**More option:**
handle additional module import
- Method1: add path in `detection/__init__.py`, e.g.
```python
import sys

#change the location
sys.path.append("/home/app/function")
```
- Method2: use --build-arg `ADDITIONAL_PACKAGE_FOLDERNAME=<path to package relate to detection/>`: copy folder in `build/detection/function` to python env of function container, e.g.
```shell
$ faas-cli build -f detection.yml --build-arg ADDITIONAL_PACKAGE_FOLDERNAME=mypackage
```

handle additional file
- Method1 : modify the `template/python3-debian/Dockerfile` to store the file, e.g.
```
RUN mkdir -p darknet
WORKDIR ${VAR_CWD}/darknet
RUN wget https://raw.githubusercontent.com/pjreddie/darknet/master/data/coco.names
```
- Method2: use --build-arg `ADDITIONAL_FILE_FOLDERNAME=<path to package relate to detection/>`: copy folder in `build/detection/function` to cwd of function container, e.g.
```shell
$ faas-cli build -f detection.yml --build-arg ADDITIONAL_FILE_FOLDERNAME=darknet
```

### How To Call Openfass Handler
- url: e.g. `http://127.0.0.1:31112/async-function/detection`
- set header: e.g. `X-Callback-Url=http://127.0.0.1:31112/function/other`
- request body: filename:String, e.g. `yolotest.mp4`
- response body: userid at lastline; e.g.
```
remove:  user_yolotest.mp4
username: yolotest.mp4, userid: 5dea6815d956f9d4dca5dff5, collection name: user_yolotest.mp4
video temp path:  /tmp/yolotest.mp4
Reading Frame...
Read Frame total:  19
Userid:  5dea6815d956f9d4dca5dff5
5dea6815d956f9d4dca5dff5
```

After calling, check MongoDB user collection with userid to get the processed images. see "User process" below 

## Database
Redis and MongoDB

### Redis
Store video binary

schema:
```Javascript
{
    "key":String, //videoname 
    "value": Bytes, //videoBytes
```

test: see `asynchandlerTest.py`

### MongoDB
Database has one collection for all users process and one collection per user name. If duplicated user name, remove collection of older user name. 
- Database name: `comp4651`
- Users process collection name: `process`
- User collection name pattern: `user_<videoname>`, e.g. `user_yolotest.mp4`

test: see `handlerTest.py`

#### User process
Store all users process.

status: 
- `pending`: processing
- `done`: processed
- `removed`: user's collection removed

schema:
```Javascript
{
    "_id":ObjectId, //userobject id (generated by mongodb)
    "username": String, //videoname 
    "status": String, //process status
}
```

To get particular user status:
```python
mongoclient = pymongo.MongoClient("mongodb://localhost:27017/")
comp4651DB = mongoclient["comp4651"]
processCol = comp4651DB["process"]
status = processCol.find_one({"_id":userid})["status"]
```

To get lastest user objectid of same username:
```python
mongoclient = pymongo.MongoClient("mongodb://localhost:27017/")
comp4651DB = mongoclient["comp4651"]
processCol = comp4651DB["process"]
result = processCol.find({"username":username})
for x in result:
    if x["status"]!="removed":
        userid = str(x["_id"])
```

#### User collection
store all processed images of a username

schema:
```Javascript
{
    "_id":ObjectId, //image id (generated by mongodb)
    "frameno": float, //frame number
    "name": String, //image name (pattern `<username>_<frameno>.jpg`)
    "userid": String, //user object id string
    "base64": String, //base64 encoded jpg,
}
```

To get all image of the user:
```python
mongoclient = pymongo.MongoClient("mongodb://localhost:27017/")
comp4651DB = mongoclient["comp4651"]
comp4651DB["user_"+str(videoname)].find({"userid":userid}).sort("frameno")
```

base64 for test in client: `yolotest.mp4_0.jpg_w.txt`
- `data:image/jpeg;base64, <base64>`
